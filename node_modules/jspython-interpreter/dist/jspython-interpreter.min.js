!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jspython={})}(this,(function(e){"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,n)};function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r,o=function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function i(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function s(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function a(e,t){for(var n=0,r=t.length,o=e.length;n<r;n++,o++)e[o]=t[n];return e}!function(e){e[e.Arithmetic=0]="Arithmetic",e[e.Assignment=1]="Assignment",e[e.Comparison=2]="Comparison",e[e.Logical=3]="Logical",e[e.Membership=4]="Membership"}(r||(r={}));var c,l={"+":r.Arithmetic,"-":r.Arithmetic,"*":r.Arithmetic,"/":r.Arithmetic,"%":r.Arithmetic,"**":r.Arithmetic,"//":r.Arithmetic,">":r.Comparison,">=":r.Comparison,"==":r.Comparison,"!=":r.Comparison,"<>":r.Comparison,"<":r.Comparison,"<=":r.Comparison,and:r.Logical,or:r.Logical,in:r.Membership,"=":r.Assignment,"+=":r.Assignment,"-=":r.Assignment,"*=":r.Assignment,"/=":r.Assignment,"++":r.Assignment,"--":r.Assignment},u={"+":function(e,t){return p(e,t,"+")},"-":function(e,t){return p(e,t,"-")},"/":function(e,t){return p(e,t,"/")},"*":function(e,t){return p(e,t,"*")},"%":function(e,t){return p(e,t,"%")},"**":function(e,t){return p(e,t,"**")},"//":function(e,t){return p(e,t,"//")},">":function(e,t){return f(e,t,">")},">=":function(e,t){return f(e,t,">=")},"<":function(e,t){return f(e,t,"<")},"<=":function(e,t){return f(e,t,"<=")},"==":function(e,t){return f(e,t,"==")},"!=":function(e,t){return f(e,t,"!=")},"<>":function(e,t){return f(e,t,"<>")},and:function(e,t){return h(e,t,"and")},or:function(e,t){return h(e,t,"or")},in:function(e,t){return function(e,t,n){if("string"==typeof e)return e.includes(String(t));if(Array.isArray(e))return e.includes(t);throw new Error("Unknown operation '"+n+"'")}(e,t,"in")}};function h(e,t,n){switch(n){case"and":return e&&t;case"or":return e||t}throw new Error("Unknown operation '"+n+"'")}function f(e,t,n){switch(n){case"==":return e===t;case"!=":case"<>":return e!==t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}throw new Error("Unknown operation '"+n+"'")}function p(e,t,n){switch(n){case"+":return e+t;case"-":return e-t;case"*":return e*t;case"/":return e/t;case"%":return e%t;case"**":return Math.pow(e,t)}throw new Error("Unknown operation '"+n+"'")}function d(e){return e[1][0]}function y(e){return e?e[0]:null}function v(e){return e[1].subarray(1)}function m(e){return e[1][1]}function g(e){return e[1][2]}function k(e,t){var n=[];if(!e.length)return[];for(var r=w(e,(function(e){return e===t})),o=0,i=0;i<r.length;i++){var s=r[i];n.push(e.slice(o,s)),o=s+1}return n.push(e.slice(o,e.length)),n}function b(e,t,n){void 0===n&&(n=0);for(var r=n;r<e.length;r++)if(d(e[r])!==c.LiteralString)if("("===y(e[r]))r=C(e,r,"(",")");else if("["===y(e[r]))r=C(e,r,"[","]");else if("{"===y(e[r]))r=C(e,r,"{","}");else if(t(y(e[r])))return r;return-1}function w(e,t){for(var n=[],r=0;r<e.length;r++){var o=y(e[r]);d(e[r])!==c.LiteralString&&("("===o?r=C(e,r,"(",")"):"["===o?r=C(e,r,"[","]"):"{"===o?r=C(e,r,"{","}"):t(o)&&n.push(r))}return n}function N(e,t){return void 0===t&&(t=null),w(e,t?function(e){return l[e]===t}:function(e){return void 0!==l[e]})}function C(e,t,n,r){for(var o=0;y(e[++t])!==r||0!==o;){if(t+1>=e.length)throw new Error("Closing '"+r+"' is missing");var i=y(e[t]);i===n&&o++,i===r&&o--}return t}!function(e){e[e.Identifier=0]="Identifier",e[e.Keyword=1]="Keyword",e[e.Separator=2]="Separator",e[e.Operator=3]="Operator",e[e.LiteralNumber=4]="LiteralNumber",e[e.LiteralBool=5]="LiteralBool",e[e.LiteralString=6]="LiteralString",e[e.LiteralNull=7]="LiteralNull",e[e.Comment=8]="Comment"}(c||(c={}));var x=function(e){this.type=e,this.loc=void 0},A=function(e){function t(t,n,r){var o=e.call(this,"assign")||this;return o.target=t,o.source=n,o.loc=r,o.loc=r,o}return n(t,e),t}(x),E=function(e){function t(t){var n=e.call(this,"const")||this;return n.value=y(t),n.loc=v(t),n}return n(t,e),t}(x),S=function(e){function t(t,n){var r=e.call(this,"comment")||this;return r.comment=t,r.loc=n,r.loc=n,r}return n(t,e),t}(x),O=function(e){function t(t,n){void 0===t&&(t=void 0);var r=e.call(this,"return")||this;return r.returnValue=t,r.loc=n,r.loc=n,r}return n(t,e),t}(x),_=function(e){function t(t,n,r){var o=e.call(this,"raise")||this;return o.errorName=t,o.errorMessage=n,o.loc=r,o.loc=r,o}return n(t,e),t}(x),j=function(e){function t(){return e.call(this,"continue")||this}return n(t,e),t}(x),L=function(e){function t(){return e.call(this,"break")||this}return n(t,e),t}(x);!function(e){function t(t){var n=e.call(this,"setSingleVar")||this;return n.name=t[0],n.loc=v(t),n}n(t,e)}(x);var B=function(e){function t(t,n,r){var o=e.call(this,"funcCall")||this;return o.name=t,o.paramNodes=n,o.loc=r,o.nullCoelsing=void 0,o.loc=r,o}return n(t,e),t}(x),T=function(e){function t(t,n,r,o){var i=e.call(this,"funcDef")||this;return i.funcAst=t,i.params=n,i.isAsync=r,i.loc=o,i.loc=o,i}return n(t,e),t}(x),P=function(e){function t(t,n,r){var o=e.call(this,"arrowFuncDef")||this;return o.funcAst=t,o.params=n,o.loc=r,o.loc=r,o}return n(t,e),t}(x),F=function(e){function t(t,n,r,o){void 0===r&&(r=void 0);var i=e.call(this,"if")||this;return i.conditionNode=t,i.ifBody=n,i.elseBody=r,i.loc=o,i.loc=o,i}return n(t,e),t}(x),I=function(e){function t(t,n,r,o,i){var s=e.call(this,"tryExcept")||this;return s.tryBody=t,s.exepts=n,s.elseBody=r,s.finallyBody=o,s.loc=i,s.loc=i,s}return n(t,e),t}(x),W=function(e){function t(t,n,r,o){var i=e.call(this,"for")||this;return i.sourceArray=t,i.itemVarName=n,i.body=r,i.loc=o,i.loc=o,i}return n(t,e),t}(x),V=function(e){function t(t,n,r){var o=e.call(this,"while")||this;return o.condition=t,o.body=n,o.loc=r,o.loc=r,o}return n(t,e),t}(x),M=function(e){function t(t,n,r,o){void 0===r&&(r=void 0);var i=e.call(this,"import")||this;return i.module=t,i.body=n,i.parts=r,i.loc=o,i.loc=o,i}return n(t,e),t}(x),U=function(e){function t(t,n){void 0===n&&(n=void 0);var r=e.call(this,"getSingleVar")||this;return r.nullCoelsing=void 0,r.name=t[0],r.nullCoelsing=n,r.loc=v(t),r}return n(t,e),t}(x),J=function(e){function t(t,n){var r=e.call(this,"dotObjectAccess")||this;return r.nestedProps=t,r.loc=n,r.loc=n,r}return n(t,e),t}(x),D=function(e){function t(t,n){var r=e.call(this,"createObject")||this;return r.props=t,r.loc=n,r.loc=n,r}return n(t,e),t}(x),z=function(e){function t(t,n){var r=e.call(this,"createArray")||this;return r.items=t,r.loc=n,r.loc=n,r}return n(t,e),t}(x),K=function(e){function t(t,n,r,o){void 0===r&&(r=void 0);var i=e.call(this,"bracketObjectAccess")||this;return i.propertyName=t,i.bracketBody=n,i.nullCoalescing=r,i.loc=o,i.loc=o,i}return n(t,e),t}(x),R=function(e){function t(t,n){var r=e.call(this,"logicalOp")||this;return r.items=t,r.loc=n,r.loc=n,r}return n(t,e),t}(x),G=function(e){function t(t,n,r,o){var i=e.call(this,"binOp")||this;return i.left=t,i.op=n,i.right=r,i.loc=o,i.loc=o,i}return n(t,e),t}(x);function q(e,t,n,r,o){return e+": "+t+"("+n+","+r+"): "+o}!function(e){function t(n,r,o,i){var s=e.call(this)||this;return s.module=n,s.line=r,s.column=o,s.message=i,s.message=q("JspyTokenizerError",n,r,o,i),Object.setPrototypeOf(s,t.prototype),s}n(t,e)}(Error);var H=function(e){function t(n,r,o,i){var s=e.call(this)||this;return s.module=n,s.line=r,s.column=o,s.message=i,s.message=q("JspyParserError",n,r,o,i),Object.setPrototypeOf(s,t.prototype),s}return n(t,e),t}(Error),Q=function(e){function t(n,r,o,i){var s=e.call(this)||this;return s.module=n,s.line=r,s.column=o,s.message=i,s.message=q("JspyEvalError",n,r,o,i),Object.setPrototypeOf(s,t.prototype),s}return n(t,e),t}(Error),X=function(e){function t(n,r,o,i,s){var a=e.call(this)||this;return a.module=n,a.line=r,a.column=o,a.name=i,a.message=s,a.message=q("JspyError",n||"name.jspy",r,o,s),Object.setPrototypeOf(a,t.prototype),a}return n(t,e),t}(Error);function Y(e){return{moduleName:e.moduleName,blockScope:e.blockScope.clone()}}var Z=function(){function e(e){this.scope={},this.scope=o({},e)}return e.prototype.getScope=function(){return this.scope},e.prototype.clone=function(){return new e(this.scope)},e.prototype.set=function(e,t,n){this.scope[e]=t},e.prototype.get=function(e,t){return this.scope[e]},e}(),$=function(){function e(){}return e.prototype.evalBlock=function(e,t){for(var n=this,r=null,o=function(e){var r=e;t.blockScope.set(r.funcAst.name,(function(){for(var e=[],o=0;o<arguments.length;o++)e[o]=arguments[o];return n.jspyFuncInvoker.apply(n,a([r,t],e))}))},i=0,s=(null==e?void 0:e.funcs)||[];i<s.length;i++){o(u=s[i])}for(var c=0,l=e.body;c<l.length;c++){var u;if("comment"!==(u=l[c]).type){if("import"===u.type)throw new Error("Import is not support with 'eval'. Use method 'evalAsync' instead");try{if(r=this.evalNode(u,t),t.returnCalled){var h=t.returnObject;return"func"!=e.type&&"module"!=e.type||(t.returnCalled=!1,t.returnObject=null),h}if(t.continueCalled)break;if(t.breakCalled)break}catch(e){var f=u.loc?u.loc:[0,0];throw e instanceof X||e instanceof Q?e:new Q(t.moduleName,f[0],f[1],e.message||e)}}}return r},e.prototype.jspyFuncInvoker=function(e,t){for(var n,r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];var i=Object.assign({},e.funcAst);i.type="func";for(var s=Y(t),a=0;a<(null===(n=e.params)||void 0===n?void 0:n.length);a++){var c=(null==r?void 0:r.length)>a?r[a]:null;s.blockScope.set(e.params[a],c)}return this.evalBlock(i,s)},e.prototype.invokeFunction=function(e,t,n){if(0===t.length)return e();if(1===t.length)return e(t[0]);if(2===t.length)return e(t[0],t[1]);if(3===t.length)return e(t[0],t[1],t[2]);if(4===t.length)return e(t[0],t[1],t[2],t[3]);if(5===t.length)return e(t[0],t[1],t[2],t[3],t[4]);if(6===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5]);if(7===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6]);if(8===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]);if(9===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]);if(10===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9]);if(11===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10]);if(12===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]);if(13===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]);if(14===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13]);if(15===t.length)return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14]);throw Error("Function has too many parameters. Current limitation is 15")},e.prototype.evalNode=function(e,t){var n,r,o,i,s,c,l,h=this;if("import"===e.type)return null;if("comment"===e.type)return null;if("if"!==e.type){if("raise"===e.type){var f,p=e;throw new X(t.moduleName,p.loc[0],p.loc[1],p.errorName,p.errorMessage||"")}if("tryExcept"!==e.type){if("return"===e.type){var d=e;return t.returnCalled=!0,t.returnObject=d.returnValue?this.evalNode(d.returnValue,t):null,t.returnObject}if("continue"!==e.type)if("break"!==e.type)if("for"!==e.type)if("while"!==e.type){if("const"===e.type)return e.value;if("getSingleVar"===e.type){var y=e.name,v=t.blockScope.get(e.name);if(void 0===v)throw";"===y.charAt(y.length-1)?new Error("Unexpected ';' in the end."):new Error("Variable '"+y+"' is not defined.");return v}if("binOp"===e.type){var m=e,g=this.evalNode(m.left,t),k=this.evalNode(m.right,t);return u[m.op](g,k)}if("logicalOp"===e.type){for(var b=e,w=0,N=!0;w<b.items.length;){var C=b.items[w++];if(N=this.evalNode(C.node,t),"and"===C.op&&!N)return!1;if("or"===C.op&&N)return N}return N}if("arrowFuncDef"===e.type){var x=e;return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return h.jspyFuncInvoker.apply(h,a([x,t],e))}}if("funcCall"===e.type){var A=e;if("function"!=typeof(V=t.blockScope.get(A.name)))throw Error("'"+A.name+"' is not a function or not defined.");var E=(null===(c=A.paramNodes)||void 0===c?void 0:c.map((function(e){return h.evalNode(e,t)})))||[];return this.invokeFunction(V,E,{moduleName:t.moduleName,line:A.loc[0],column:A.loc[1]})}if("assign"===e.type){var S=e;if("getSingleVar"===S.target.type){var O=S.target;t.blockScope.set(O.name,this.evalNode(S.source,t))}else if("dotObjectAccess"===S.target.type){var _=S.target,j=new J(_.nestedProps.slice(0,_.nestedProps.length-1),_.loc);this.evalNode(j,t)[_.nestedProps[_.nestedProps.length-1].name]=this.evalNode(S.source,t)}else{if("bracketObjectAccess"!==S.target.type)throw Error("Not implemented Assign operation");_=S.target;var L=this.evalNode(_.bracketBody,t);t.blockScope.get(_.propertyName)[L]=this.evalNode(S.source,t)}return null}if("bracketObjectAccess"===e.type){var B=e,T=this.evalNode(B.bracketBody,t);return void 0===(M=t.blockScope.get(B.propertyName))[T]?null:M[T]}if("dotObjectAccess"===e.type){var P=e,F=this.evalNode(P.nestedProps[0],t);for(Y=1;Y<P.nestedProps.length;Y++){var I=P.nestedProps[Y];if(P.nestedProps[Y-1].nullCoelsing&&!F&&(F={}),"getSingleVar"===I.type)F=F[I.name];else if("bracketObjectAccess"===I.type){var W=I;F=(F=F[W.propertyName])[this.evalNode(W.bracketBody,t)]}else{if("funcCall"!==I.type)throw Error("Can't resolve dotObjectAccess node");var V;if(null==(V=F[(A=I).name])&&P.nestedProps[Y-1].nullCoelsing){F=null;continue}if("function"!=typeof V)throw Error("'"+A.name+"' is not a function or not defined.");E=(null===(l=A.paramNodes)||void 0===l?void 0:l.map((function(e){return h.evalNode(e,t)})))||[];F=this.invokeFunction(V.bind(F),E,{moduleName:t.moduleName,line:A.loc[0],column:A.loc[1]})}}return void 0===F?null:F}if("createObject"===e.type){for(var M={},U=0,D=e.props;U<D.length;U++){var z=D[U];M[this.evalNode(z.name,t)]=this.evalNode(z.value,t)}return M}if("createArray"===e.type){for(var K=[],R=0,G=e.items;R<G.length;R++){Z=G[R];K.push(this.evalNode(Z,t))}return K}}else{for(var q=e;this.evalNode(q.condition,t)&&(this.evalBlock({name:t.moduleName,type:"while",body:q.body},t),t.continueCalled&&(t.continueCalled=!1),!t.breakCalled););t.breakCalled&&(t.breakCalled=!1)}else{for(var H=e,Q=this.evalNode(H.sourceArray,t),Y=0;Y<Q.length;Y++){var Z=Q[Y];if(t.blockScope.set(H.itemVarName,Z),this.evalBlock({name:t.moduleName,type:"for",body:H.body},t),t.continueCalled&&(t.continueCalled=!1),t.breakCalled)break}t.breakCalled&&(t.breakCalled=!1)}else t.breakCalled=!0;else t.continueCalled=!0}else{var $=e;try{this.evalBlock({name:t.moduleName,type:"trycatch",body:$.tryBody},t),(null===(n=$.elseBody)||void 0===n?void 0:n.length)&&this.evalBlock({name:t.moduleName,type:"trycatch",body:$.elseBody},t)}catch(f){var ee=f instanceof X?f.name:typeof f,te=f instanceof X?f.message:null!==(r=null==f?void 0:f.message)&&void 0!==r?r:String(f),ne=f instanceof X?f.module:0,re=f instanceof X?f.line:0,oe=f instanceof X?f.column:0,ie=$.exepts[0],se=ie.body,ae=t;ae.blockScope.set((null===(o=ie.error)||void 0===o?void 0:o.alias)||"error",{name:ee,message:te,line:re,column:oe,moduleName:ne}),this.evalBlock({name:t.moduleName,type:"trycatch",body:se},ae),ae.blockScope.set((null===(i=ie.error)||void 0===i?void 0:i.alias)||"error",null)}finally{(null===(s=$.finallyBody)||void 0===s?void 0:s.length)&&this.evalBlock({name:t.moduleName,type:"trycatch",body:$.finallyBody},t)}}}else{var ce=e;this.evalNode(ce.conditionNode,t)?this.evalBlock({name:t.moduleName,type:"if",body:ce.ifBody},t):ce.elseBody&&this.evalBlock({name:t.moduleName,type:"if",body:ce.elseBody},t)}},e}(),ee=function(){function e(){this.moduleParser=function(){return Promise.reject("Module parser is not registered!")}}return e.prototype.registerModuleParser=function(e){return this.moduleParser=e,this},e.prototype.registerBlockContextFactory=function(e){return this.blockContextFactory=e,this},e.prototype.evalBlockAsync=function(e,t){var n,r;return i(this,void 0,void 0,(function(){var o,c,l,u,h,f,p,d,y,v,m,g,k,b,w=this;return s(this,(function(N){switch(N.label){case 0:for(o=null,c=function(e){var n=e,r=t.blockScope,o=n.isAsync?function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return i(w,void 0,void 0,(function(){return s(this,(function(r){switch(r.label){case 0:return[4,this.jspyFuncInvokerAsync.apply(this,a([n,t],e))];case 1:return[2,r.sent()]}}))}))}:function(){for(var e,r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];return(e=new $).jspyFuncInvoker.apply(e,a([n,t],r))};r.set(n.funcAst.name,o)},l=0,u=(null==e?void 0:e.funcs)||[];l<u.length;l++)p=u[l],c(p);h=0,f=e.body,N.label=1;case 1:if(!(h<f.length))return[3,8];if("comment"===(p=f[h]).type)return[3,7];if("import"!==p.type)return[3,4];if(!(d=p).module.name.startsWith("/"))return[3,7];if("function"!=typeof this.blockContextFactory)throw new Error("blockContextFactory is not initialized");return[4,this.moduleParser(d.module.name)];case 2:return y=N.sent(),v=this.blockContextFactory(d.module.name,y),[4,this.evalBlockAsync(y,v)];case 3:return N.sent(),m=t.blockScope.getScope(),(null===(n=d.parts)||void 0===n?void 0:n.length)||(m={},t.blockScope.set(d.module.alias||this.defaultModuleName(d.module.name),m)),this.assignFunctionsToScope(m,v,y,null===(r=d.parts)||void 0===r?void 0:r.map((function(e){return e.name}))),[3,7];case 4:return N.trys.push([4,6,,7]),[4,this.evalNodeAsync(p,t)];case 5:return o=N.sent(),t.returnCalled?(g=t.returnObject,"func"!=e.type&&"module"!=e.type||(t.returnCalled=!1,t.returnObject=null),[2,g]):t.continueCalled||t.breakCalled?[3,8]:[3,7];case 6:throw k=N.sent(),b=p.loc?p.loc:[0,0],k instanceof X||k instanceof Q?k:new Q(t.moduleName,b[0],b[1],k.message||k);case 7:return h++,[3,1];case 8:return[2,o]}}))}))},e.prototype.assignFunctionsToScope=function(e,t,n,r){for(var o=this,c=n.funcs.filter((function(e){var t;return!r||r.indexOf(null===(t=e.funcAst)||void 0===t?void 0:t.name)>=0})),l=function(n){var r=c[n],l=r.isAsync?function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return i(o,void 0,void 0,(function(){return s(this,(function(n){switch(n.label){case 0:return[4,this.jspyFuncInvokerAsync.apply(this,a([r,t],e))];case 1:return[2,n.sent()]}}))}))}:function(){for(var e,n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];return(e=new $).jspyFuncInvoker.apply(e,a([r,t],n))};e[r.funcAst.name]=l},u=0;u<c.length;u++)l(u)},e.prototype.defaultModuleName=function(e){return e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))},e.prototype.jspyFuncInvokerAsync=function(e,t){for(var n,r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];return i(this,void 0,void 0,(function(){var o,i,a,c;return s(this,(function(s){switch(s.label){case 0:for((o=Object.assign({},e.funcAst)).type="func",i=Y(t),a=0;a<(null===(n=e.params)||void 0===n?void 0:n.length);a++)c=(null==r?void 0:r.length)>a?r[a]:null,i.blockScope.set(e.params[a],c);return[4,this.evalBlockAsync(o,i)];case 1:return[2,s.sent()]}}))}))},e.prototype.invokeFunctionAsync=function(e,t,n){return i(this,void 0,void 0,(function(){return s(this,(function(n){switch(n.label){case 0:return 0!==t.length?[3,2]:[4,e()];case 1:return[2,n.sent()];case 2:return 1!==t.length?[3,4]:[4,e(t[0])];case 3:return[2,n.sent()];case 4:return 2!==t.length?[3,6]:[4,e(t[0],t[1])];case 5:return[2,n.sent()];case 6:return 3!==t.length?[3,8]:[4,e(t[0],t[1],t[2])];case 7:return[2,n.sent()];case 8:return 4!==t.length?[3,10]:[4,e(t[0],t[1],t[2],t[3])];case 9:return[2,n.sent()];case 10:return 5!==t.length?[3,12]:[4,e(t[0],t[1],t[2],t[3],t[4])];case 11:return[2,n.sent()];case 12:return 6!==t.length?[3,14]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5])];case 13:return[2,n.sent()];case 14:return 7!==t.length?[3,16]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])];case 15:return[2,n.sent()];case 16:return 8!==t.length?[3,18]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7])];case 17:return[2,n.sent()];case 18:return 9!==t.length?[3,20]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])];case 19:return[2,n.sent()];case 20:return 10!==t.length?[3,22]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9])];case 21:return[2,n.sent()];case 22:return 11!==t.length?[3,24]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10])];case 23:return[2,n.sent()];case 24:return 12!==t.length?[3,26]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11])];case 25:return[2,n.sent()];case 26:return 13!==t.length?[3,28]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12])];case 27:return[2,n.sent()];case 28:return 14!==t.length?[3,30]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13])];case 29:return[2,n.sent()];case 30:return 15!==t.length?[3,32]:[4,e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14])];case 31:return[2,n.sent()];case 32:throw Error("Function has too many parameters. Current limitation is 15")}}))}))},e.prototype.evalNodeAsync=function(e,t){var n,r,o,c,l;return i(this,void 0,void 0,(function(){var i,h,f,p,d,y,v,m,g,k,b,w,N,C,x,A,E,S,O,_,j,L,B,T,P,F,I,W,V,M,U,D,z,K,R,G,q,H,Q,Y,Z,ee,te,ne,re,oe,ie,se,ae,ce,le,ue,he,fe,pe,de,ye,ve,me,ge,ke,be,we,Ne,Ce,xe,Ae,Ee,Se,Oe,_e,je,Le;return s(this,(function(s){switch(s.label){case 0:if("import"===e.type)throw new Error("Import should be defined at the start");return"comment"===e.type?[2,null]:"if"!==e.type?[3,6]:(i=e,[4,this.evalNodeAsync(i.conditionNode,t)]);case 1:return s.sent()?[4,this.evalBlockAsync({name:t.moduleName,type:"if",body:i.ifBody},t)]:[3,3];case 2:return s.sent(),[3,5];case 3:return i.elseBody?[4,this.evalBlockAsync({name:t.moduleName,type:"if",body:i.elseBody},t)]:[3,5];case 4:s.sent(),s.label=5;case 5:return[2];case 6:if("raise"===e.type)throw h=e,new X(t.moduleName,h.loc[0],h.loc[1],h.errorName,h.errorMessage||"");if("tryExcept"!==e.type)return[3,17];f=e,s.label=7;case 7:return s.trys.push([7,11,13,16]),[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:f.tryBody},t)];case 8:return s.sent(),(null===(n=f.elseBody)||void 0===n?void 0:n.length)?[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:f.elseBody},t)]:[3,10];case 9:s.sent(),s.label=10;case 10:return[3,16];case 11:return p=s.sent(),d=p instanceof X?p.name:typeof p,y=p instanceof X?p.message:null!==(r=null==p?void 0:p.message)&&void 0!==r?r:String(p),v=p instanceof X?p.module:0,m=p instanceof X?p.line:0,g=p instanceof X?p.column:0,k=f.exepts[0],b=k.body,(w=t).blockScope.set((null===(o=k.error)||void 0===o?void 0:o.alias)||"error",{name:d,message:y,line:m,column:g,moduleName:v}),[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:b},w)];case 12:return s.sent(),w.blockScope.set((null===(c=k.error)||void 0===c?void 0:c.alias)||"error",null),[3,16];case 13:return(null===(l=f.finallyBody)||void 0===l?void 0:l.length)?[4,this.evalBlockAsync({name:t.moduleName,type:"trycatch",body:f.finallyBody},t)]:[3,15];case 14:s.sent(),s.label=15;case 15:return[7];case 16:return[2];case 17:return"return"!==e.type?[3,21]:(N=e,t.returnCalled=!0,C=t,N.returnValue?[4,this.evalNodeAsync(N.returnValue,t)]:[3,19]);case 18:return x=s.sent(),[3,20];case 19:x=null,s.label=20;case 20:return C.returnObject=x,[2,t.returnObject];case 21:return"continue"===e.type?(t.continueCalled=!0,[2]):"break"===e.type?(t.breakCalled=!0,[2]):"for"!==e.type?[3,27]:(A=e,[4,this.evalNodeAsync(A.sourceArray,t)]);case 22:E=s.sent(),le=0,s.label=23;case 23:return le<E.length?(_e=E[le],t.blockScope.set(A.itemVarName,_e),[4,this.evalBlockAsync({name:t.moduleName,type:"for",body:A.body},t)]):[3,26];case 24:if(s.sent(),t.continueCalled&&(t.continueCalled=!1),t.breakCalled)return[3,26];s.label=25;case 25:return le++,[3,23];case 26:return t.breakCalled&&(t.breakCalled=!1),[2];case 27:if("while"!==e.type)return[3,32];S=e,s.label=28;case 28:return[4,this.evalNodeAsync(S.condition,t)];case 29:return s.sent()?[4,this.evalBlockAsync({name:t.moduleName,type:"while",body:S.body},t)]:[3,31];case 30:return s.sent(),t.continueCalled&&(t.continueCalled=!1),t.breakCalled?[3,31]:[3,28];case 31:return t.breakCalled&&(t.breakCalled=!1),[2];case 32:if("const"===e.type)return[2,e.value];if("getSingleVar"===e.type){if(O=e.name,void 0===(_=t.blockScope.get(O)))throw";"===O.charAt(O.length-1)?new Error("Unexpected ';' in the end."):new Error("Variable '"+O+"' is not defined.");return[2,_]}return"binOp"!==e.type?[3,35]:(j=e,[4,this.evalNodeAsync(j.left,t)]);case 33:return L=s.sent(),[4,this.evalNodeAsync(j.right,t)];case 34:return B=s.sent(),[2,u[j.op](L,B)];case 35:if("logicalOp"!==e.type)return[3,39];T=e,P=0,F=!0,s.label=36;case 36:return P<T.items.length?(I=T.items[P++],[4,this.evalNodeAsync(I.node,t)]):[3,38];case 37:return F=s.sent(),"and"!==I.op||F?"or"===I.op&&F?[2,F]:[3,36]:[2,!1];case 38:return[2,F];case 39:if("arrowFuncDef"===e.type)return W=e,[2,function(){for(var e,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return(e=new $).jspyFuncInvoker.apply(e,a([W,t],n))}];if("funcCall"!==e.type)return[3,45];if(pe=e,"function"!=typeof(de=t.blockScope.get(pe.name)))throw Error("'"+pe.name+"' is not a function or not defined.");ye=[],V=0,M=pe.paramNodes||[],s.label=40;case 40:return V<M.length?(Ce=M[V],D=(U=ye).push,[4,this.evalNodeAsync(Ce,t)]):[3,43];case 41:D.apply(U,[s.sent()]),s.label=42;case 42:return V++,[3,40];case 43:return[4,this.invokeFunctionAsync(de,ye,{moduleName:t.moduleName,line:pe.loc[0],column:pe.loc[0]})];case 44:return[2,s.sent()];case 45:return"assign"!==e.type?[3,55]:"getSingleVar"!==(z=e).target.type?[3,47]:(K=z.target,G=(R=t.blockScope).set,q=[K.name],[4,this.evalNodeAsync(z.source,t)]);case 46:return G.apply(R,q.concat([s.sent()])),[3,54];case 47:return"dotObjectAccess"!==z.target.type?[3,50]:(ee=z.target,H=new J(ee.nestedProps.slice(0,ee.nestedProps.length-1),ee.loc),[4,this.evalNodeAsync(H,t)]);case 48:return ne=s.sent(),Q=ee.nestedProps[ee.nestedProps.length-1].name,Y=ne,Z=Q,[4,this.evalNodeAsync(z.source,t)];case 49:return Y[Z]=s.sent(),[3,54];case 50:return"bracketObjectAccess"!==z.target.type?[3,53]:(ee=z.target,[4,this.evalNodeAsync(ee.bracketBody,t)]);case 51:return te=s.sent(),ne=t.blockScope.get(ee.propertyName),re=ne,oe=te,[4,this.evalNodeAsync(z.source,t)];case 52:return re[oe]=s.sent(),[3,54];case 53:throw Error("Not implemented Assign operation");case 54:return[2,null];case 55:return"bracketObjectAccess"!==e.type?[3,57]:(ie=e,[4,this.evalNodeAsync(ie.bracketBody,t)]);case 56:return se=s.sent(),[2,void 0===(be=t.blockScope.get(ie.propertyName))[se]?null:be[se]];case 57:return"dotObjectAccess"!==e.type?[3,71]:(ae=e,[4,this.evalNodeAsync(ae.nestedProps[0],t)]);case 58:ce=s.sent(),le=1,s.label=59;case 59:return le<ae.nestedProps.length?(ue=ae.nestedProps[le],ae.nestedProps[le-1].nullCoelsing&&!ce&&(ce={}),"getSingleVar"!==ue.type?[3,60]:(ce=ce[ue.name],[3,69])):[3,70];case 60:return"bracketObjectAccess"!==ue.type?[3,62]:(ce=ce[(he=ue).propertyName],fe=ce,[4,this.evalNodeAsync(he.bracketBody,t)]);case 61:return ce=fe[s.sent()],[3,69];case 62:if("funcCall"!==ue.type)return[3,68];if(null==(de=ce[(pe=ue).name])&&ae.nestedProps[le-1].nullCoelsing)return ce=null,[3,69];if("function"!=typeof de)throw Error("'"+pe.name+"' is not a function or not defined.");ye=[],ve=0,me=pe.paramNodes||[],s.label=63;case 63:return ve<me.length?(Ce=me[ve],ke=(ge=ye).push,[4,this.evalNodeAsync(Ce,t)]):[3,66];case 64:ke.apply(ge,[s.sent()]),s.label=65;case 65:return ve++,[3,63];case 66:return[4,this.invokeFunctionAsync(de.bind(ce),ye,{moduleName:t.moduleName,line:pe.loc[0],column:pe.loc[0]})];case 67:return ce=s.sent(),[3,69];case 68:throw Error("Can't resolve dotObjectAccess node");case 69:return le++,[3,59];case 70:return[2,void 0===ce?null:ce];case 71:if("createObject"!==e.type)return[3,77];be={},we=0,Ne=e.props,s.label=72;case 72:return we<Ne.length?(Ce=Ne[we],xe=be,[4,this.evalNodeAsync(Ce.name,t)]):[3,76];case 73:return Ae=s.sent(),[4,this.evalNodeAsync(Ce.value,t)];case 74:xe[Ae]=s.sent(),s.label=75;case 75:return we++,[3,72];case 76:return[2,be];case 77:if("createArray"!==e.type)return[3,82];Ee=[],Se=0,Oe=e.items,s.label=78;case 78:return Se<Oe.length?(_e=Oe[Se],Le=(je=Ee).push,[4,this.evalNodeAsync(_e,t)]):[3,81];case 79:Le.apply(je,[s.sent()]),s.label=80;case 80:return Se++,[3,78];case 81:return[2,Ee];case 82:return[2]}}))}))},e}(),te={jsPython:function(){return["JSPython v2.1.5","(c) 2021 FalconSoft Ltd. All rights reserved."].join("\n")},dateTime:function(e){return void 0===e&&(e=null),function(e){if(!e)return null;if(e instanceof Date&&!isNaN(e.valueOf()))return e;if("string"!=typeof e)return null;var t=String(e);if(!t.length)return null;var n=function(e){if(!e||!e.length)return NaN;var t=parseInt(e,10);return isNaN(t)?e.startsWith("jan")?0:e.startsWith("feb")?1:e.startsWith("mar")?2:e.startsWith("apr")?3:e.startsWith("may")?4:e.startsWith("jun")?5:e.startsWith("jul")?6:e.startsWith("aug")?7:e.startsWith("sep")?8:e.startsWith("oct")?9:e.startsWith("nov")?10:e.startsWith("dec")?11:NaN:t-1},r=function(e){return e<100?e<68?e+2e3:e+1900:e},o=function(e,t,n,r,o,i){if(t>11||n>31||r>=60||o>=60||i>=60)return null;var s=new Date(e,t,n,r,o,i,0);return isNaN(s.valueOf())?null:s},i=t.replace("T"," ").toLowerCase().split(/[: /-]/),s=i.map(parseFloat),a=o(s[0],s[1]-1,s[2],s[3]||0,s[4]||0,s[5]||0);return a||((a=o(r(s[2]),n(i[1]),s[0],s[3]||0,s[4]||0,s[5]||0))?a:(a=o(r(s[2]),n(i[0]),r(s[1]),s[3]||0,s[4]||0,s[5]||0))||null)}(e)||new Date},range:function(e,t,n){void 0===t&&(t=NaN);void 0===n&&(n=1);var r=[],o=isNaN(t);t=o?e:t;var i=e=o?0:e;for(;i<t;)r.push(i),i+=n;return r},print:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return console.log.apply(console,e),e.length>0?e[0]:null},isNull:function(e,t){return void 0===t&&(t=null),null===t?null===e:e||t},isDate:function(e){return e instanceof Date},isFunction:function(e){return"function"==typeof e},isString:function(e){return"string"==typeof e},deleteProperty:function(e,t){return delete e[t]},Math:Math,Object:Object,Array:Array,JSON:JSON,printExecutionContext:function(){},getExecutionContext:function(){}};var ne=function(){function e(){this.tokens=[]}return e.prototype.startLine=function(){return m(this.tokens[0])},e.prototype.startColumn=function(){return g(this.tokens[0])},e.prototype.endLine=function(){return this.tokens[this.tokens.length-1][1][3]},e.prototype.endColumn=function(){return this.tokens[this.tokens.length-1][1][4]},e}(),re=function(){function e(){this._currentToken=null,this._moduleName=""}return e.prototype.parse=function(e,t,n){var r;void 0===t&&(t="main.jspy"),void 0===n&&(n="module"),this._moduleName=t;var o={name:t,type:n,funcs:[],body:[]};if(!e||!e.length)return o;try{var i=this.tokensToInstructionLines(e,1);this.instructionsToNodes(i,o)}catch(e){var s=null!==(r=this._currentToken)&&void 0!==r?r:{};throw new H(o.name,m(s),g(s),e.message||e)}return o},e.prototype.instructionsToNodes=function(e,t){for(var n=this,o=function(e,r){var o=n.tokensToInstructionLines(e,m(e[r])),i={name:t.name,body:[],funcs:[]};return n.instructionsToNodes(o,i),i.body},i=function(e,t,n){return n.splice(0,n.length),N(e,t).forEach((function(e){return n.push(e)})),!!n.length},s=0;s<e.length;s++){for(var a=e[s],l=0;l<a.tokens.length;)d(a.tokens[l])===c.Comment?a.tokens.splice(l,1):l++;if(a.tokens.length){var u=a.tokens[0],h=a.tokens.length>1?a.tokens[1]:null;this._currentToken=u;var f=[];if(d(u)===c.Comment)t.body.push(new S(y(u),v(u)));else if("def"===y(u)||"async"===y(u)&&"def"===y(h)){var p="async"===y(u),g=y(a.tokens[p?2:1]),w=k(a.tokens.slice(a.tokens.findIndex((function(e){return"("===y(e)}))+1,a.tokens.findIndex((function(e){return")"===y(e)}))),",").map((function(e){return y(e[0])}));if(-1===(X=b(a.tokens,(function(e){return":"===e}))))throw"Can't find : for def";var C=this.tokensToInstructionLines(a.tokens,m(a.tokens[X+1])),x={name:g,body:[],funcs:[]};this.instructionsToNodes(C,x),t.funcs.push(new T(x,w,p,v(a.tokens[0])))}else if("if"===y(u)){if(-1===(X=b(a.tokens,(function(e){return":"===e}))))throw"Can't find : for if";var E=o(a.tokens,X+1),B=i(Y=a.tokens.slice(1,X),r.Logical,f)?this.groupLogicalOperations(f,Y):this.createExpressionNode(Y),P=void 0;e.length>s+1&&"else"===y(e[s+1].tokens[0])&&":"===y(e[s+1].tokens[1])&&(P=o(e[s+1].tokens,2),s++),t.body.push(new F(B,E,P,v(u)))}else if("try"===y(u)){if(":"!==y(a.tokens[1]))throw"'try' statement should be followed by ':'";for(var U=o(a.tokens,2),J=[],D=(P=void 0,void 0);e.length>s+1&&("else"===y(e[s+1].tokens[0])||"except"===y(e[s+1].tokens[0])||"finally"===y(e[s+1].tokens[0]));){if("else"===y(e[s+1].tokens[0])){if(P)throw new Error("Only one 'else' is allowed in a 'try'");P=o(e[s+1].tokens,2)}if("finally"===y(e[s+1].tokens[0])){if(D)throw new Error("Only one 'else' is allowed in a 'try'");D=o(e[s+1].tokens,2)}if("except"===y(e[s+1].tokens[0])){var z=b(e[s+1].tokens,(function(e){return":"===e})),K={};if(2===z)K.error={name:y(e[s+1].tokens[1])};else if(3===z)K.error={name:y(e[s+1].tokens[1]),alias:y(e[s+1].tokens[2])};else if(4===z)K.error={name:y(e[s+1].tokens[1]),alias:y(e[s+1].tokens[3])};else if(1!==z)throw new Error("Incorrect 'except:' statement. Valid stats: (except: or except Error: or except Error as e:)");K.body=o(e[s+1].tokens,z+1),J.push(K)}s++}if(!J.length)throw new Error("Except: is missing");t.body.push(new I(U,J,P,D,v(u)))}else if("continue"===y(u))t.body.push(new j);else if("break"===y(u))t.body.push(new L);else if("return"===y(u))t.body.push(new O(a.tokens.length>1?this.createExpressionNode(a.tokens.slice(1)):void 0,v(u)));else if("raise"===y(u)){if(1===a.tokens.length)throw new Error("Incorrect 'raise' usage. Please specify error name and message ");var R=y(a.tokens[1]),G=5==a.tokens.length&&"("===y(a.tokens[2])&&")"===y(a.tokens[4])?y(a.tokens[3]):void 0;t.body.push(new _(R,G,v(u)))}else if("for"===y(u)){if(-1===(X=b(a.tokens,(function(e){return":"===e}))))throw"Can't find : for if";var q=y(a.tokens[1]),H=this.createExpressionNode(a.tokens.slice(3,X)),Q=o(a.tokens,X+1);t.body.push(new W(H,q,Q,v(u)))}else if("while"===y(u)){var X;if(-1===(X=b(a.tokens,(function(e){return":"===e}))))throw"Can't find : for [while]";B=i(Y=a.tokens.slice(1,X),r.Logical,f)?this.groupLogicalOperations(f,Y):this.createExpressionNode(Y);var Y,Z=o(a.tokens,X+1);t.body.push(new V(B,Z,v(u)))}else if("import"===y(u)){var $=b(a.tokens,(function(e){return"as"===e}));$<0&&($=a.tokens.length);var ee={name:a.tokens.slice(1,$).map((function(e){return y(e)})).join(""),alias:a.tokens.slice($+1).map((function(e){return y(e)})).join("")||void 0};Z={};t.body.push(new M(ee,Z,void 0,v(u)))}else if("from"===y(u)){var te=b(a.tokens,(function(e){return"import"===e}));if(te<0)throw Error("'import' must follow 'from'");var ne={name:a.tokens.slice(1,te).map((function(e){return y(e)})).join("")},re=k(a.tokens.slice(te+1),",").map((function(e){return{name:y(e[0]),alias:3===e.length?y(e[2]):void 0}}));Z={};t.body.push(new M(ne,Z,re,v(u)))}else if(i(a.tokens,r.Assignment,[])){var oe=k(a.tokens,"="),ie=this.createExpressionNode(oe[0]),se=this.createExpressionNode(oe[1]);t.body.push(new A(ie,se,v(oe[0][0])))}else i(a.tokens,r.Logical,f)?t.body.push(this.groupLogicalOperations(f,a.tokens)):t.body.push(this.createExpressionNode(a.tokens))}}},e.prototype.sliceWithBrackets=function(e,t,n){return"("===y(e[t])&&d(e[t])!==c.LiteralString&&(t++,n--),e.slice(t,n)},e.prototype.groupComparisonOperations=function(e,t){for(var n=null,r=0;r<e.length;r++){var o=y(t[e[r]]);n=n||this.createExpressionNode(this.sliceWithBrackets(t,0,e[r]));var i=r+1<e.length?e[r+1]:t.length,s=this.createExpressionNode(this.sliceWithBrackets(t,e[r]+1,i));n=new G(n,o,s,v(t[0]))}return n},e.prototype.groupLogicalOperations=function(e,t){for(var n=0,r=[],o=0;o<e.length;o++){var i=t[e[o]],s=this.sliceWithBrackets(t,n,e[o]);r.push({node:this.createExpressionNode(s),op:y(i)}),n=e[o]+1}return r.push({node:this.createExpressionNode(this.sliceWithBrackets(t,n,t.length))}),new R(r,v(t[0]))},e.prototype.tokensToInstructionLines=function(e,t){for(var n=[],r=0,o=new ne,i=0;i<e.length;i++){var s=e[i],a=m(s),c=g(s),l=y(s);if(this._currentToken=s,a>=t&&(r!==c||")}]".includes(l)||(n.push(o),o=new ne),o.tokens.push(s),0===r&&(r=c),c<r))break}return o.tokens.length&&n.push(o),n},e.prototype.createExpressionNode=function(e,t){var n=this;if(0===e.length)throw new Error("Tokens length can't empty.");var o=e[e.length-1];if(";"===y(o)&&d(o)!==c.LiteralString)throw new Error("Unexpected symbol ';' in the end");if(this._currentToken=e[0],1===e.length||2===e.length&&"?"===y(e[1])){var i=e[0],s=d(i);if(function(e){return e===c.LiteralString||e===c.LiteralNumber||e===c.LiteralBool||e===c.LiteralNull}(s))return new E(i);if(s===c.Identifier)return new U(i,2===e.length&&"?"===y(e[1])||void 0);throw Error("Unhandled single token: '"+JSON.stringify(i)+"'")}var a=k(e,"=>");if(a.length>1){var l=k("("===y(a[0][0])?a[0].splice(1,a[0].length-2):a[0],",").map((function(e){return y(e[0])})),u=this.tokensToInstructionLines(a[1],0),h={name:this._moduleName,body:[],funcs:[]};return this.instructionsToNodes(u,h),new P(h,l,v(e[0]))}var f=N(e,r.Comparison);if(f.length)return this.groupComparisonOperations(f,e);var p=N(e);if(p.length){for(var m=null,g=0;g<p.length;g++){var b=p[g],w=y(e[b]),C=g+1<p.length?p[g+1]:null,x=null!==C?y(e[C]):null;if(null===C||"*"!==x&&"/"!==x){W=m?[]:this.sliceWithBrackets(e,0,b);var A=this.sliceWithBrackets(e,b+1,C||e.length),S=m||this.createExpressionNode(W,m),O=this.createExpressionNode(A);m=new G(S,w,O,v(e[0]))}else{var _=null;do{var j=g+2<p.length?p[g+2]:null,L=this.sliceWithBrackets(e,b+1,C),T=this.sliceWithBrackets(e,C+1,j||e.length),F=this.createExpressionNode(L),I=this.createExpressionNode(T);_=new G(F,x,I,v(e[b+1])),x=null!==(C=++g+1<p.length?p[g+1]:null)?y(e[C]):null}while(null!==C&&("*"===x||"/"===x));if(null===m){var W=this.sliceWithBrackets(e,0,b);m=this.createExpressionNode(W)}m=new G(m,w,_,v(e[0]))}}if(null===m)throw Error("Can't create node ...");return m}var V=k(e,".");if(V.length>1)return new J(V.map((function(e){return n.createExpressionNode(e)})),v(e[0]));if(e.length>2&&"("===y(e[1])){var M="?"===y(e[e.length-1]);M&&e.pop();var R=y(e[0]),q=k(re=e.slice(2,e.length-1),",").map((function(e){return n.createExpressionNode(e)})),H=new B(R,q,v(e[0]));return H.nullCoelsing=M||void 0,H}if("{"===y(e[0])&&"}"===y(e[e.length-1])){var Q=k(e.splice(1,e.length-2),","),X=[];for(g=0;g<Q.length;g++){var Y=k(Q[g],":");if(1===Y.length){var Z={name:new E(Y[0][0]),value:this.createExpressionNode(Y[0])};X.push(Z)}else{if(2!==Y.length)throw Error("Incorrect JSON");var $=null,ee=Y[0];if(1===ee.length)$=new E(ee[0]);else{if("["!==y(ee[0])||"]"!==y(ee[ee.length-1]))throw new Error("Incorrect JSON. Can't resolve Key field. That should either constant or expression in []");$=this.createExpressionNode(ee.slice(1,ee.length-1))}Z={name:$,value:this.createExpressionNode(Y[1])};X.push(Z)}}return new D(X,v(e[0]))}if("["===y(e[0])&&"]"===y(e[e.length-1])){var te=k(e.splice(1,e.length-2),",").map((function(e){return n.createExpressionNode(e)}));return new z(te,v(e[0]))}if(e.length>2&&"["===y(e[1])){var ne=y(e[0]),re=e.slice(2,e.length-1);q=this.createExpressionNode(re);return new K(ne,q,!1,v(e[0]))}throw Error("Undefined node '"+y(e[0])+"'.")},e}(),oe={"\n":["\n"],"=":["=","==","=>"],"+":["+","++","+="],"-":["-","--","-="],"*":["*","**","*="],"/":["/","//","/="],".":["."],"?":["?"],"!":["!="],":":[":"],",":[","],">":[">",">="],"<":["<","<=","<>"],"(":["("],")":[")"],"{":["{"],"}":["}"],"[":["["],"]":["]"]},ie=["async","def","for","while","if","return","in"],se=function(){function e(){this._startLine=1,this._startColumn=1,this._currentLine=1,this._currentColumn=1,this._tokenText="",this._cursor=0,this._script=""}return Object.defineProperty(e.prototype,"tokenText",{get:function(){return this._tokenText},set:function(e){!this._tokenText&&e&&(this._startLine=this._currentLine,this._startColumn=this._currentColumn),this._tokenText=e},enumerable:!1,configurable:!0}),e.prototype.tokenize=function(e){if(!e||!e.length)return[];e=e.replace(new RegExp("\t","g"),"  ").replace(new RegExp("\r","g"),""),this._script=e,this._cursor=0,this._startLine=1,this._startColumn=1,this._currentLine=1,this._currentColumn=1;for(var t=[],n=!0;"\n"===e[this._cursor];)this.incrementCursor(),n&&(this._currentLine++,n=!1),this._currentColumn=1;do{var r=e[this._cursor];if(" "!=r||0===this.tokenText.length)if(void 0===oe[r]||this.isPartOfNumber(r,t))if("#"===r){for(var o=!0;"\n"!==e[this.incrementCursor()]&&(this.tokenText+=e[this._cursor],o&&(o=!1,this._startColumn=this._startColumn-1),!(this._cursor+1>=e.length)););this.tokenText=this.processToken(this.tokenText,t,!0,c.Comment)}else if('"'===r||"'"===r){var i=r;if(this.tokenText=this.processToken(this.tokenText,t),e[this._cursor+1]===i&&e[this._cursor+2]===i){var s=this._currentLine,a=this._currentColumn;this.incrementCursor(2);for(;this.tokenText+=e[this.incrementCursor()],!(this._cursor+3>=e.length||e[this._cursor+1]===i&&e[this._cursor+2]===i&&e[this._cursor+3]===i););this._startLine=s,this._startColumn=a,this.incrementCursor(3)}else{for(;e[this.incrementCursor()]!==i&&(this.tokenText+=e[this._cursor],!(this._cursor+1>=e.length)););this._startColumn--}0===this.tokenText.length&&(this._startLine=this._currentLine,this._startColumn=this._currentColumn),this.tokenText=this.processToken(this.tokenText,t,!0,c.LiteralString)}else" "!=r&&(this.tokenText+=r);else{this.tokenText=this.processToken(this.tokenText,t),this.tokenText=r;var l=oe[r];if(l.length>=1)for(;l.includes(this.tokenText+e[this._cursor+1]);)this.tokenText+=e[this.incrementCursor()];this.tokenText=this.processToken(this.tokenText,t,!1,c.Operator)}else this.tokenText=this.processToken(this.tokenText,t)}while(this.incrementCursor()<e.length);return this.processToken(this.tokenText,t),t},e.prototype.incrementCursor=function(e){void 0===e&&(e=1);for(var t=0;t<e;t++)this._cursor=this._cursor+1,"\n"===this._script[this._cursor]?(this._currentLine++,this._currentColumn=0):this._currentColumn++;return this._cursor},e.prototype.recognizeToken=function(e,t){void 0===t&&(t=null);var n=e;return null===t&&("null"===e?(t=c.LiteralNull,n=null):"true"===e||"false"===e?(t=c.LiteralBool,n="true"===e):null!==this.parseNumberOrNull(e)?(t=c.LiteralNumber,n=this.parseNumberOrNull(e)):t=ie.indexOf(e)>=0?c.Keyword:c.Identifier),{value:n,type:t}},e.prototype.processToken=function(e,t,n,r){if(void 0===n&&(n=!1),void 0===r&&(r=null),!e.length&&!n||"\n"===e)return"";var o=this.recognizeToken(e,r);return t.push([o.value,Uint16Array.of(o.type,this._startLine,this._startColumn,this._currentLine,this._currentColumn)]),""},e.prototype.parseNumberOrNull=function(e){if("number"==typeof e)return e;if(!e||"string"!=typeof e)return null;for(var t=(e=e.trim()).length-1;t>=0;t--){var n=e.charCodeAt(t);if((n<48||n>57)&&46!==n&&44!==n&&(45!==n||0!==t))return null}var r=parseFloat(e);return isNaN(r)?null:r},e.prototype.isPartOfNumber=function(e,t){if("-"===e&&!this.tokenText.length){var n=0!==t.length?t[t.length-1]:null;return null===n||d(n)===c.Operator&&")"!==y(n)}return"."===e&&null!==this.parseNumberOrNull(this.tokenText)},e}();var ae=function(){function e(){this.initialScope=o({},te),this._lastExecutionContext=null}return e.create=function(){return new e},Object.defineProperty(e.prototype,"initialExecutionContext",{get:function(){return this.initialScope},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastExecutionContext",{get:function(){return this._lastExecutionContext},enumerable:!1,configurable:!0}),e.prototype.cleanUp=function(){this._lastExecutionContext=null},e.prototype.jsPythonInfo=function(){return te.jsPython()},e.prototype.tokenize=function(e){return(new se).tokenize(e)},e.prototype.parse=function(e,t){void 0===t&&(t="main.jspy");var n=new se;return(new re).parse(n.tokenize(e),t)},e.prototype.eval=function(e,t,n,r){void 0===t&&(t={}),void 0===n&&(n=""),void 0===r&&(r="main.jspy");var o="string"==typeof e?this.parse(e,r):e,i={moduleName:r,blockScope:new Z(t)};i.blockScope.set("printExecutionContext",(function(){return console.log(i.blockScope.getScope())})),i.blockScope.set("getExecutionContext",(function(){return i.blockScope.getScope()})),this._lastExecutionContext=i.blockScope.getScope();var s=(new $).evalBlock(o,i);if(n&&n.length){var a=i.blockScope.get(n);if("function"!=typeof a)throw Error("Function "+n+" does not exists or not a function");return a()}return s},e.prototype.evalAsync=function(e,t,n,r){return void 0===t&&(t={}),void 0===n&&(n=""),void 0===r&&(r="main.jspy"),i(this,void 0,void 0,(function(){var o,a,c,l,u,h=this;return s(this,(function(f){switch(f.label){case 0:return o="string"==typeof e?this.parse(e,r):e,a=new ee,(c={moduleName:r,blockScope:new Z(t)}).blockScope.set("printExecutionContext",(function(){return console.log(c.blockScope.getScope())})),c.blockScope.set("getExecutionContext",(function(){return c.blockScope.getScope()})),this._lastExecutionContext=c.blockScope.getScope(),[4,a.registerModuleParser((function(e){return i(h,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return[4,this.moduleParser(e)];case 1:return[2,t.sent()]}}))}))})).registerBlockContextFactory((function(e,n){var r=h.assignLegacyImportContext(n,t),o={moduleName:e,blockScope:new Z(r)};return o.blockScope.set("printExecutionContext",(function(){return console.log(o.blockScope.getScope())})),o.blockScope.set("getExecutionContext",(function(){return o.blockScope.getScope()})),o})).evalBlockAsync(o,c)];case 1:return l=f.sent(),n&&n.length?[3,2]:[2,l];case 2:if("function"!=typeof(u=c.blockScope.get(n)))throw Error("Function "+n+" does not exists or not a function");return[4,u()];case 3:return[2,f.sent()]}}))}))},e.prototype.evaluate=function(e,t,n,r){return void 0===t&&(t={}),void 0===n&&(n=""),void 0===r&&(r="main.jspy"),i(this,void 0,void 0,(function(){var i,a;return s(this,(function(s){switch(s.label){case 0:return e&&e.length?(i=this.parse(e,r),t=t&&"object"==typeof t?t:{},t=this.assignLegacyImportContext(i,t),a=o(o({},this.initialScope),t),[4,this.evalAsync(i,a,n,r)]):[2,null];case 1:return[2,s.sent()]}}))}))},e.prototype.registerPackagesLoader=function(e){if("function"!=typeof e)throw Error("PackagesLoader");return this.packageLoader=e,this},e.prototype.registerModuleLoader=function(e){if("function"!=typeof e)throw Error("ModuleLoader should be a function");return this.moduleLoader=e,this},e.prototype.addFunction=function(e,t){return this.initialScope[e]=t,this},e.prototype.assignGlobalContext=function(e){return Object.assign(this.initialScope,e),this},e.prototype.hasFunction=function(e,t){return void 0===e&&(e=""),e.indexOf("def "+t)>-1},e.prototype.assignLegacyImportContext=function(e,t){var n=e.body.filter((function(e){return"import"===e.type})).filter((function(e){return!e.module.name.startsWith("/")})).map((function(e){return function(e){var t;return{name:e.module.name,as:e.module.alias,properties:null===(t=e.parts)||void 0===t?void 0:t.map((function(e){return{name:e.name,as:e.alias}}))}}(e)}));if(n.length&&this.packageLoader){var r=this.packageResolver(n);t=o(o({},t),r)}return t},e.prototype.moduleParser=function(e){return i(this,void 0,void 0,(function(){var t;return s(this,(function(n){switch(n.label){case 0:if(!this.moduleLoader)throw new Error("Module Loader is not registered");return[4,this.moduleLoader(e)];case 1:return t=n.sent(),[2,this.parse(t,e)]}}))}))},e.prototype.packageResolver=function(e){var t=this;if(!this.packageLoader)throw Error("Package loader not provided.");var n={};return e.forEach((function(e){var r=e.name,o=e.as,i=e.properties,s=t.packageLoader&&t.packageLoader(r);(null==i?void 0:i.length)?i.forEach((function(e){n[e.as||e.name]=s[e.name]})):o?n[o]=s:n[r]=s,o&&(n[o]=s)})),n},e}();e.Interpreter=ae,e.jsPython=function(){return ae.create()},Object.defineProperty(e,"__esModule",{value:!0})}));//# sourceMappingURL=jspython-interpreter.min.js.map
